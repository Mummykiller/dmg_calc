<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDO Damage Calculator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="page-wrapper">
        <div class="title-wrapper">
            <h1>DDO Damage Calculator</h1>
            <!-- Modern Theme Toggle Switch -->
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-toggle-checkbox" title="Toggle Dark/Light Mode">
                    <input type="checkbox" id="theme-toggle-checkbox" />
                    <div class="slider round"></div>
                </label>
            </div>
        </div>
        <p class="subtitle">Enter your combat stats to calculate and compare average damage per hit.</p>

        <nav class="set-navigation">
            <button id="add-set-btn" title="Add a new weapon set for comparison">+</button>
            <button id="add-spell-set-btn" title="Add a new spell set for comparison">ðŸ”®</button>
            <button id="import-btn" class="nav-action-btn" title="Import sets from text or file">Import</button>
            <button id="export-btn" class="nav-action-btn" title="Export sets to text or file">Export</button>
        </nav>

        <div class="calculator-wrapper">
            <!-- Calculator sets will be dynamically inserted here by script.js -->

        </div>

        <div class="comparison-container">
            <h2>Set Comparison</h2>
            <table id="comparison-table">
                <thead>
                    <tr>
                        <th>Set Name</th>
                        <th>Total Avg Dmg</th>
                        <th>% Diff</th>
                        <th>Avg Base</th>
                        <th>Avg Sneak</th>
                        <th>Avg Imbue</th>
                        <th>Avg Unscaled</th>
                    </tr>
                </thead>
                <tbody id="comparison-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Import/Export -->
    <div id="modal-backdrop" class="modal-backdrop hidden">
        <div id="io-modal" class="modal">
            <h2 id="modal-title">Export Sets</h2>
            <p id="modal-description">Copy the text below or save it to a file.</p>
            <div class="modal-format-toggle">
                <label>Format:</label>
                <button id="format-json-btn" class="toggle-btn active" title="Machine-readable format for re-importing">JSON</button>
                <button id="format-summary-btn" class="toggle-btn" title="Human-readable summary for sharing">Summary</button>
            </div>
            <textarea id="modal-textarea" rows="10"></textarea>
            <div class="modal-actions">
                <!-- Buttons for Export -->
                <button id="modal-copy-btn">Copy to Clipboard</button>
                <button id="modal-save-file-btn">Save to File</button>
                <!-- Buttons for Import -->
                <button id="modal-load-btn" class="hidden">Load from Text</button>
                <input type="file" id="modal-file-input" accept=".json, .txt" class="hidden">
                <button id="modal-close-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Template for a single calculator set -->
    <template id="calculator-set-template">
        <div class="main-grid">
            <div class="input-column">
                <div class="stats-group">
                    <div class="input-group-row">
                        <label for="weapon-dice">Weapon Dice [W]</label>
                        <input type="number" id="weapon-dice" value="7" min="0" class="small-input">
                    </div>
                    <div class="example-text">e.g., 1d6+3</div>
                    <div class="input-group-row">
                        <label for="weapon-damage">Damage</label>
                        <input type="text" id="weapon-damage" value="1d10+3" title="Weapon's base damage dice + enhancement bonus">
                        <span class="plus-symbol">+</span>
                        <input type="number" id="bonus-base-damage" value="125" class="small-input" title="Bonus damage that IS multiplied on a critical hit">
                    </div>
                </div>
                <div class="stats-group">
                    <div class="input-group-row">
                        <label for="crit-threat">Critical</label>
                        <input type="text" id="crit-threat" value="15-20" class="small-input" title="Enter threat range size (e.g., 6) or the roll numbers (e.g., 15-20)">
                        <span class="divider-symbol">/</span>
                        <input type="number" id="crit-multiplier" value="4" step="0.5" class="small-input" title="Critical Multiplier (e.g., x4)">
                    </div>
                    <div class="input-group-row">
                        <label for="seeker-damage">Seeker</label>
                        <input type="number" id="seeker-damage" value="0" class="small-input" title="Bonus damage on critical hits that gets multiplied (e.g., from Seeker items)">
                    </div>
                    <div class="input-group-row">
                        <label for="crit-multiplier-19-20">19-20 Multiplier</label>
                        <input type="number" id="crit-multiplier-19-20" value="2" step="0.5" class="small-input" title="Additional critical multiplier on a roll of 19 or 20 (e.g., a value of 1 here with a base x4 multiplier results in a x5 on a 19-20).">
                    </div>
                </div>
                <div class="stats-group">
                    <div class="input-group-row">
                        <label for="miss-threshold">Miss on Roll â‰¤</label>
                        <input type="number" id="miss-threshold" value="1" min="1" max="20" class="small-input" title="Rolls at or below this value are a miss. (1 is always a miss).">
                        <label for="graze-threshold" title="Rolls at or below this value (but above miss) are a graze.">Graze on Roll â‰¤</label>
                        <input type="number" id="graze-threshold" value="5" min="1" max="20" class="small-input">
                    </div>
                    <label for="graze-percent">Graze Damage %</label>
                    <input type="number" id="graze-percent" value="20" min="0" max="100" class="small-input">
                </div>
                <div class="stats-group">
                    <div id="unscaled-rows-container">
                            <label>Unscaled Damage Sources (e.g., 16d6 acid)</label>
                        <!-- Default unscaled rows -->
                        <div class="input-group-row">
                            <label for="unscaled-damage-1">Unscaled Damage 1</label>
                            <input type="text" id="unscaled-damage-1" value="0" title="Additional source of unscaled damage">
                            <label for="unscaled-proc-chance-1" class="short-label">Proc %</label>
                            <input type="number" id="unscaled-proc-chance-1" value="100" min="0" max="100" class="small-input" title="Chance for this damage to occur on a hit">
                            <input type="checkbox" id="unscaled-doublestrike-1" checked><label for="unscaled-doublestrike-1" class="inline-checkbox-label" title="Should this damage scale with Doublestrike/Doubleshot?">Multi-Strike</label>
                            <input type="checkbox" id="unscaled-on-crit-1"><label for="unscaled-on-crit-1" class="inline-checkbox-label" title="Should this damage only apply on a critical hit?">On Crit</label>
                            <button class="remove-row-btn" title="Remove this damage source">&times;</button>
                        </div>
                        <div class="input-group-row">
                            <label for="unscaled-damage-2">Unscaled Damage 2</label>
                            <input type="text" id="unscaled-damage-2" value="0" title="Additional source of unscaled damage">
                            <label for="unscaled-proc-chance-2" class="short-label">Proc %</label>
                            <input type="number" id="unscaled-proc-chance-2" value="100" min="0" max="100" class="small-input" title="Chance for this damage to occur on a hit">
                            <input type="checkbox" id="unscaled-doublestrike-2" checked><label for="unscaled-doublestrike-2" class="inline-checkbox-label" title="Should this damage scale with Doublestrike/Doubleshot?">Multi-Strike</label>
                            <input type="checkbox" id="unscaled-on-crit-2"><label for="unscaled-on-crit-2" class="inline-checkbox-label" title="Should this damage only apply on a critical hit?">On Crit</label>
                            <button class="remove-row-btn" title="Remove this damage source">&times;</button>
                        </div>
                        <div class="input-group-row">
                            <label for="unscaled-damage-3">Unscaled Damage 3</label>
                            <input type="text" id="unscaled-damage-3" value="0" title="Additional source of unscaled damage">
                            <label for="unscaled-proc-chance-3" class="short-label">Proc %</label>
                            <input type="number" id="unscaled-proc-chance-3" value="100" min="0" max="100" class="small-input" title="Chance for this damage to occur on a hit">
                            <input type="checkbox" id="unscaled-doublestrike-3" checked><label for="unscaled-doublestrike-3" class="inline-checkbox-label" title="Should this damage scale with Doublestrike/Doubleshot?">Multi-Strike</label>
                            <input type="checkbox" id="unscaled-on-crit-3"><label for="unscaled-on-crit-3" class="inline-checkbox-label" title="Should this damage only apply on a critical hit?">On Crit</label>
                            <button class="remove-row-btn" title="Remove this damage source">&times;</button>
                        </div>
                    </div>
                    <button id="add-unscaled-row-btn" class="small-btn" style="width: auto; margin-top: 0.5rem;">Add Unscaled Damage</button>
                </div>
                <div class="stats-group">
                    <div class="input-group-row"><label for="doublestrike">Multi-Strike (%)</label><input type="number" id="doublestrike" value="0" min="0" class="small-input"><input type="checkbox" id="is-doubleshot"><label for="is-doubleshot" class="checkbox-label">Is Doubleshot</label></div>
                    <div class="input-group-row"><label for="melee-power">Melee/Ranged Power</label><input type="number" id="melee-power" value="0" min="0" class="small-input"></div>
                    <div class="input-group-row"><label for="spell-power">Spell Power</label><input type="number" id="spell-power" value="0" min="0" class="small-input"></div>
                    <div class="input-group-row">
                        <label for="reaper-skulls">Reaper Skulls</label>
                        <select id="reaper-skulls" class="small-input" title="Number of Reaper skulls for difficulty scaling.">
                            <option value="0">None</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
                <div class="stats-group">
                    <label class="section-headline">Sneak Attack & Deception</label>
                    <div class="input-group-row">
                        <label for="sneak-attack-dice">Sneak Attack</label>
                        <input type="number" id="sneak-attack-dice" value="0" class="small-input" title="Number of Sneak Attack d6 dice">
                        <span class="dice-separator">d6</span><span class="plus-symbol">+</span>
                        <input type="number" id="sneak-bonus" value="0" class="small-input" title="Flat bonus to Sneak Attack damage">
                    </div>
                </div>
                <div class="stats-group">
                    <div class="input-group-row">
                        <label for="imbue-dice-count">Imbue Dice</label>
                        <input type="number" id="imbue-dice-count" value="0" class="small-input" title="Number of imbue dice">
                        <span class="dice-separator">d</span>
                        <input type="number" id="imbue-die-type" value="6" class="small-input" title="Type of imbue dice (e.g., 6 for d6, 8 for d8)">
                    </div>
                    <div class="input-group-row">
                        <label for="imbue-scaling">Scaling %</label>
                        <input type="number" id="imbue-scaling" value="100" class="small-input" title="Percentage of Melee/Spell Power to apply to imbue damage">
                        <input type="checkbox" id="imbue-uses-spellpower"><label for="imbue-uses-spellpower" class="checkbox-label">Use Spell Power</label>
                    </div>
                    <div class="input-group-row">
                        <label for="imbue-crits" class="checkbox-label" title="If checked, the base imbue damage is applied an additional time on a critical hit (e.g., Monk finishers).">Imbue crits for extra damage</label>
                        <input type="checkbox" id="imbue-crits">
                    </div>
                    <div class="input-group-row">
                        <button id="set-75-scaling-btn" class="small-btn">75%</button>
                        <button id="set-100-scaling-btn" class="small-btn">100%</button>
                        <button id="set-150-scaling-btn" class="small-btn">150%</button>
                        <button id="set-200-scaling-btn" class="small-btn">200%</button>
                    </div>
                </div>
                <button id="calculate-btn">Calculate Average Damage</button>
            </div>
            <div class="results-column">
                <div id="results-container" class="results">
                    <div class="summary-results">
                        <h2 id="summary-header">Summary</h2>
                        <p><strong>Total Avg Base Hit:</strong> <span id="avg-base-damage">0</span></p>
                        <p><strong>Total Avg Sneak Attack:</strong> <span id="avg-sneak-damage">0</span></p>
                        <p><strong>Total Avg Imbue:</strong> <span id="avg-imbue-damage">0</span></p>
                        <p><strong>Total Avg Unscaled:</strong> <span id="avg-unscaled-damage">0</span></p>
                        <p class="total-damage-summary"><strong>Total Average Damage:</strong> <span id="total-avg-damage">0</span></p>
                    </div>
                    <div class="scaling-breakdown">
                        <h2>Scaling Breakdown</h2>
                        <p><strong>Weapon Scaling:</strong> <span id="weapon-scaling">0</span></p>
                        <p><strong>Sneak Scaling:</strong> <span id="sneak-scaling">0</span></p>
                        <p><strong>Imbue Scaling:</strong> <span id="imbue-scaling-breakdown">0</span></p>
                        <p><strong>Imbue Power:</strong> <span id="imbue-power-source">0</span></p>
                        <p><strong>Reaper Penalty:</strong> <span id="reaper-penalty">0.0%</span></p>

                    </div>
                    <div class="roll-results">
                        <h2>Damage per d20 Roll</h2>
                        <table id="roll-damage-table">
                            <thead>
                                <tr>
                                    <th>Roll</th>
                                    <th>Base Dmg</th>
                                    <th>Sneak</th>
                                    <th>Imbue</th>
                                    <th>Unscaled</th>
                                    <th>Sum</th>
                                    <th>Outcome</th>
                                </tr>
                            </thead><tbody id="roll-damage-tbody"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Template for a single spell calculator set -->
    <template id="spell-calculator-template">
        <div class="main-grid">
            <div class="input-column">
                <div class="stats-group">
                    <label class="section-headline">Spell Properties</label>
                    <div class="input-group-row">
                        <label for="spell-damage">Base Damage</label>
                        <input type="text" id="spell-damage" value="10d6" title="The spell's base damage dice (e.g., 10d6+50)">
                    </div>
                    <div class="input-group-row">
                        <label for="caster-level">Caster Level</label>
                        <input type="number" id="caster-level" value="20" class="small-input" title="Your character's caster level for this spell.">
                    </div>
                </div>
                <div class="stats-group">
                    <label class="section-headline">Spell Power & Criticals</label>
                    <div class="input-group-row">
                        <label for="spell-power">Spell Power</label>
                        <input type="number" id="spell-power" value="500" class="small-input" title="Your spell power for the spell's damage type.">
                        <span class="plus-symbol">+</span>
                        <span id="metamagic-spell-power-bonus" class="read-only-bonus">0</span>
                    </div>
                    <div class="input-group-row">
                        <label for="spell-crit-chance">Crit Chance %</label>
                        <input type="number" id="spell-crit-chance" value="20" class="small-input" title="Your chance to critically hit with the spell.">
                    </div>
                    <div class="input-group-row">
                        <label for="spell-crit-damage">Crit Damage %</label>
                        <input type="number" id="spell-crit-damage" value="100" class="small-input" title="Your additional spell critical damage (e.g., 100 for a total of x3 multiplier).">
                    </div>
                </div>
                <div class="stats-group">
                    <label class="section-headline">Target Defenses</label>
                    <div class="input-group-row">
                        <label for="target-mrr">Target MRR</label>
                        <input type="number" id="target-mrr" value="50" class="small-input" title="The target's Magical Resistance Rating.">
                    </div>
                </div>
                <div class="stats-group">
                    <label class="section-headline">Metamagic</label>
                    <div class="input-group-row">
                        <input type="checkbox" id="metamagic-empower"><label for="metamagic-empower" class="checkbox-label">Empower</label>
                        <input type="checkbox" id="metamagic-maximize"><label for="metamagic-maximize" class="checkbox-label">Maximize</label>
                        <input type="checkbox" id="metamagic-intensify"><label for="metamagic-intensify" class="checkbox-label">Intensify</label>
                    </div>
                </div>
                <button id="calculate-spell-btn">Calculate Spell Damage</button>
            </div>
            <div class="results-column">
                <div id="spell-results-container" class="results">
                    <div class="summary-results">
                        <h2 id="spell-summary-header">Spell Damage Summary</h2>
                        <p><strong>Average Base Hit:</strong> <span id="avg-spell-damage">0</span></p>
                        <p><strong>Average Critical Hit:</strong> <span id="avg-spell-crit-damage">0</span></p>
                        <p class="total-damage-summary"><strong>Total Average Damage (pre-MRR):</strong> <span id="total-avg-spell-damage">0</span></p>
                        <hr>
                        <p><strong>Damage Mitigated by MRR:</strong> <span id="mrr-mitigation">0</span></p>
                        <p class="total-damage-summary"><strong>Final Average Damage:</strong> <span id="final-spell-damage">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Link to the JavaScript file at the end of the body -->
    <script src="SpellCalculator.js"></script>
    <script src="script.js"></script>
</body>
</html>